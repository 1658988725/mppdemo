/******************************************************************************

  Copyright (C), 2016, Hisilicon Tech. Co., Ltd.

 ******************************************************************************
  File Name     : imx477_sensor_ctl.c
  Version       : Initial Draft
  Author        : Hisilicon BVT ISP group
  Created       :
  Description   : Sony IMX477 sensor driver
  History       :
  1.Date        :
  Author        :
  Modification  : Created file

******************************************************************************/

#include <stdio.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/ioctl.h>
#include <fcntl.h>
#include <unistd.h>
//#include "hi_comm_video.h"
#include "hi_sns_ctrl.h"
#include "mpi_sys.h"
#include "mpi_isp.h"

#include "imx477_slave_priv.h"
//#include "drv_i2c.h"
#include "hi_i2c.h"

extern const IMX477_VIDEO_MODE_TBL_S g_astImx477ModeTbl[];
extern ISP_SLAVE_SNS_SYNC_S gstImx477Sync[];
extern HI_S32 g_Imx477SlaveBindDev[];
extern HI_U8 g_u8SensorImageMode;

static int g_fd[ISP_MAX_PIPE_NUM] = {[0 ... (ISP_MAX_PIPE_NUM - 1)] = -1};
static HI_BOOL g_bStart[ISP_MAX_PIPE_NUM];
extern ISP_SNS_STATE_S             g_astImx477[ISP_MAX_PIPE_NUM];
extern ISP_SNS_COMMBUS_U     g_aunImx477BusInfo[];

const unsigned char imx477_i2c_addr     =    0x34;        /* I2C Address of IMX477 */
const unsigned int  imx477_addr_byte    =    2;
const unsigned int  imx477_data_byte    =    1;

#define NA 0xFFFF
static const HI_U16 gs_au16SensorCfgSeq[][IMX477_MODE_BUTT + 1] =
{
    //mode0,mode1,mode2,mode3
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x3F0B},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3041},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3040},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x4b81},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x4B2F}, //new add
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x4B80}, //new add
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0350}, //new add
    {0x18, 0x18, 0x18, 0x18, 0x18, 0x0136},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0137},
    {0x02, 0x02, 0x02, 0x02, 0x02, 0x0808},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0xE07A},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xE000},
    {0x18, 0x18, 0x18, 0x18, 0x18, 0x4AE9},
    {0x08, 0x08, 0x08, 0x08, 0x08, 0x4AEA},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0xF61C},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0xF61E},
    {0x21, 0x21, 0x21, 0x21, 0x21, 0x4AE9},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x4AEA},
    {0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x38A8},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x38A9},
    {0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x38AA},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x38AB},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x420B},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x55D4},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x55D5},
    {0x07, 0x07, 0x07, 0x07, 0x07, 0x55D6},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x55D7},
    {0x07, 0x07, 0x07, 0x07, 0x07, 0x55E8},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x55E9},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x55EA},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x55EB},
    {0x07, 0x07, 0x07, 0x07, 0x07, 0x574C},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x574D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x574E},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x574F},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x5754},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x5755},
    {0x07, 0x07, 0x07, 0x07, 0x07, 0x5756},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x5757},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x5973},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x5974},
    {0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0x5D13},
    {0x58, 0x58, 0x58, 0x58, 0x58, 0x5D14},
    {0xA3, 0xA3, 0xA3, 0xA3, 0xA3, 0x5D15},
    {0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x5D16},
    {0x65, 0x65, 0x65, 0x65, 0x65, 0x5D17},
    {0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x5D18},
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x5D1A},
    {0xA9, 0xA9, 0xA9, 0xA9, 0xA9, 0x5D1B},
    {0x45, 0x45, 0x45, 0x45, 0x45, 0x5D1C},
    {0x3A, 0x3A, 0x3A, 0x3A, 0x3A, 0x5D1D},
    {0xAB, 0xAB, 0xAB, 0xAB, 0xAB, 0x5D1E},
    {0x15, 0x15, 0x15, 0x15, 0x15, 0x5D1F},
    {0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x5D21},
    {0x52, 0x52, 0x52, 0x52, 0x52, 0x5D22},
    {0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x5D23},
    {0x7D, 0x7D, 0x7D, 0x7D, 0x7D, 0x5D24},
    {0x57, 0x57, 0x57, 0x57, 0x57, 0x5D25},
    {0xA8, 0xA8, 0xA8, 0xA8, 0xA8, 0x5D26},
    {0x5A, 0x5A, 0x5A, 0x5A, 0x5A, 0x5D37},
    {0x5A, 0x5A, 0x5A, 0x5A, 0x5A, 0x5D38},
    {0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x5D77},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7B7C},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7B7D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x8D1F},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x8D27},
    {0x03, 0x03, 0x03, 0x03, 0x03, 0x9004},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9200},
    {0x6C, 0x6C, 0x6C, 0x6C, 0x6C, 0x9201},
    {0x71, 0x71, 0x71, 0x71, 0x71, 0x9202},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9203},
    {0x71, 0x71, 0x71, 0x71, 0x71, 0x9204},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x9205},
    {0x6A, 0x6A, 0x6A, 0x6A, 0x6A, 0x9371},
    {0x6A, 0x6A, 0x6A, 0x6A, 0x6A, 0x9373},
    {0x64, 0x64, 0x64, 0x64, 0x64, 0x9375},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x990C},
    {0x08, 0x08, 0x08, 0x08, 0x08, 0x990D},
    {0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x9956},
    {0x64, 0x64, 0x64, 0x64, 0x64, 0x9957},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9958},
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x9A48},
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x9A49},
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x9A4A},
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x9A4B},
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x9A4C},
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x9A4D},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0xA001},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0xA003},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0xA005},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0xA006},
    {0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xA007},
    {0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xA009},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x3D8A},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x7B3B},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7B4C},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9905},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9907},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9909},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x990B},
    {0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x9944},
    {0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x9947},
    {0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x994A},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x994B},
    {0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x994C},
    {0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x994D},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x994E},
    {0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x994F},
    {0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x9950},
    {0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x9951},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9952},
    {0x8C, 0x8C, 0x8C, 0x8C, 0x8C, 0x9953},
    {0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x9954},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9955},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x9A13},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x9A14},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9A19},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x9A1C},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x9A1D},
    {0x05, 0x05, 0x05, 0x05, 0x05, 0x9A26},
    {0x05, 0x05, 0x05, 0x05, 0x05, 0x9A27},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x9A2C},
    {0x03, 0x03, 0x03, 0x03, 0x03, 0x9A2D},
    {0x05, 0x05, 0x05, 0x05, 0x05, 0x9A2F},
    {0x05, 0x05, 0x05, 0x05, 0x05, 0x9A30},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9A41},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9A46},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9A47},
    {0x35, 0x35, 0x35, 0x35, 0x35, 0x9C17},
    {0x31, 0x31, 0x31, 0x31, 0x31, 0x9C1D},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9C29},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9C3B},
    {0x6B, 0x6B, 0x6B, 0x6B, 0x6B, 0x9C41},
    {0x2D, 0x2D, 0x2D, 0x2D, 0x2D, 0x9C47},
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x9C4D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9C6B},
    {0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0x9C71},
    {0x32, 0x32, 0x32, 0x32, 0x32, 0x9C73},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x9C75},
    {0x2D, 0x2D, 0x2D, 0x2D, 0x2D, 0x9C7D},
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x9C83},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9C94},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9C95},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9C96},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9C97},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9C98},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9C99},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9C9A},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9C9B},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9C9C},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9CA0},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9CA1},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9CA2},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9CA3},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9CA4},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9CA5},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9CA6},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9CA7},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9CA8},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9CA9},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9CAA},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9CAB},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9CAC},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9CAD},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9CAE},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9CBD},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9CBF},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9CC1},
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x9CC3},
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x9CC5},
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x9CC7},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9CC9},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9CCB},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9CCD},
    {0x35, 0x35, 0x35, 0x35, 0x35, 0x9D17},
    {0x31, 0x31, 0x31, 0x31, 0x31, 0x9D1D},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9D29},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9D3B},
    {0x6B, 0x6B, 0x6B, 0x6B, 0x6B, 0x9D41},
    {0x42, 0x42, 0x42, 0x42, 0x42, 0x9D47},
    {0x5A, 0x5A, 0x5A, 0x5A, 0x5A, 0x9D4D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9D6B},
    {0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0x9D71},
    {0x32, 0x32, 0x32, 0x32, 0x32, 0x9D73},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x9D75},
    {0x42, 0x42, 0x42, 0x42, 0x42, 0x9D7D},
    {0x5A, 0x5A, 0x5A, 0x5A, 0x5A, 0x9D83},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9D94},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9D95},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9D96},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9D97},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9D98},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9D99},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9D9A},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9D9B},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9D9C},
    {0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x9D9D},
    {0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x9D9E},
    {0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x9D9F},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9DA0},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9DA1},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9DA2},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9DA3},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9DA4},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9DA5},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9DA6},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9DA7},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9DA8},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9DA9},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9DAA},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9DAB},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9DAC},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9DAD},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9DAE},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9DC9},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9DCB},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9DCD},
    {0x35, 0x35, 0x35, 0x35, 0x35, 0x9E17},
    {0x31, 0x31, 0x31, 0x31, 0x31, 0x9E1D},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9E29},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9E3B},
    {0x6B, 0x6B, 0x6B, 0x6B, 0x6B, 0x9E41},
    {0x2D, 0x2D, 0x2D, 0x2D, 0x2D, 0x9E47},
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x9E4D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9E6B},
    {0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0x9E71},
    {0x32, 0x32, 0x32, 0x32, 0x32, 0x9E73},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x9E75},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9E94},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9E95},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9E96},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9E97},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9E98},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9E99},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9EA0},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9EA1},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9EA2},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9EA3},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9EA4},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9EA5},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9EA6},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9EA7},
    {0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x9EA8},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9EA9},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9EAA},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9EAB},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9EAC},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9EAD},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9EAE},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9EC9},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9ECB},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9ECD},
    {0x35, 0x35, 0x35, 0x35, 0x35, 0x9F17},
    {0x31, 0x31, 0x31, 0x31, 0x31, 0x9F1D},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0x9F29},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9F3B},
    {0x6B, 0x6B, 0x6B, 0x6B, 0x6B, 0x9F41},
    {0x42, 0x42, 0x42, 0x42, 0x42, 0x9F47},
    {0x5A, 0x5A, 0x5A, 0x5A, 0x5A, 0x9F4D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9F6B},
    {0xC8, 0xC8, 0xC8, 0xC8, 0xC8, 0x9F71},
    {0x32, 0x32, 0x32, 0x32, 0x32, 0x9F73},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0x9F75},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9F94},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9F95},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9F96},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9F97},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9F98},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9F99},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9F9A},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9F9B},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9F9C},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9F9D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9F9E},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9F9F},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9FA0},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9FA1},
    {0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x9FA2},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9FA3},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9FA4},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9FA5},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9FA6},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9FA7},
    {0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x9FA8},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9FA9},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9FAA},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9FAB},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9FAC},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9FAD},
    {0x09, 0x09, 0x09, 0x09, 0x09, 0x9FAE},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9FC9},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9FCB},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x9FCD},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xA14B},
    {0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0xA151},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0xA153},
    {0x02, 0x02, 0x02, 0x02, 0x02, 0xA155},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xA157},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xA1AD},
    {0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0xA1B3},
    {0x50, 0x50, 0x50, 0x50, 0x50, 0xA1B5},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xA1B9},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xA24B},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xA257},
    {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xA2AD},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xA2B9},
    {0x04, 0x04, 0x04, 0x04, 0x04, 0xB21F},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xB35C},
    {0x08, 0x08, 0x08, 0x08, 0x08, 0xB35E},

    {0x0C, 0x0C, 0x0C, 0x0A, 0x0A, 0x0112},
    {0x0C, 0x0C, 0x0C, 0x0A, 0x0A, 0x0113},
    {0x03, 0x03, 0x03, 0x03, 0x03, 0x0114},
    {0x1F, 0x30, 0x18, 0x13, 0x0C, 0x0342},
    {0x40, 0x20, 0xB0, 0x88, 0x1C, 0x0343}, //d4
    {0x0D, 0x08, 0x08, 0x0D, 0x04, 0x0340},
    {0xAC, 0xe3, 0xA7, 0x20, 0x6A, 0x0341}, //c0
    {0x00, 0x00, 0x00, 0x01, 0x00, 0x0344}, //xStart[12:8]
    {0x00, 0x6C, 0x6C, 0xF4, 0x60, 0x0345}, //xStart[7:0]
    {0x00, 0x01, 0x01, 0x00, 0x01, 0x0346}, //yStart[12:8]
    {0x00, 0xB8, 0xB8, 0x00, 0xB8, 0x0347}, //yStart[7:0]
    {0x0F, 0x0F, 0x0F, 0x0D, 0x0F, 0x0348}, //xEnd[12:8]
    {0xD7, 0x6B, 0x6B, 0xAB, 0x73, 0x0349}, //xEnd[7:0]
    {0x0B, 0x0A, 0x0A, 0x0B, 0x0A, 0x034A}, //yEnd[12:8]
    {0xDF, 0x27, 0x27, 0xB7, 0x27, 0x034B}, //yEnd[7:0]
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00E3},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00E4},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x00FC},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x00FD},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x00FE},
    {0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x00FF},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0220},
    {0x11, 0x11, 0x11, 0x11, 0x11, 0x0221},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x0381},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x0383},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x0385},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x0387},
    {0x00, 0x00, 0x00, 0x00, 0x01, 0x0900},
    {0x11, 0x11, 0x11, 0x11, 0x22, 0x0901},
    {0x02, 0x02, 0x02, 0x02, 0x02, 0x0902},
    {0x02, 0x02, 0x02, 0x02, 0x02, 0x3140},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3C00},
    {0x03, 0x03, 0x03, 0x03, 0x01, 0x3C01},
    {0xA2, 0xA2, 0xA2, 0xDC, 0x9C, 0x3C02},
    {0x01, 0x01, 0x01, 0x00, 0x00, 0x3F0D},
    {0x07, 0x07, 0x07, 0x07, 0x00, 0x5748},
    {0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x5749},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x574A},
    {0x00, 0x00, 0x00, 0x00, 0xA4, 0x574B},
    {0x0A, 0x0A, 0x0A, 0x0E, 0x0E, 0x7B75},
    {0x0C, 0x0C, 0x0C, 0x09, 0x09, 0x7B76},
    {0x07, 0x07, 0x07, 0x0C, 0x08, 0x7B77},
    {0x06, 0x06, 0x06, 0x06, 0x06, 0x7B78},
    {0x3C, 0x3C, 0x3C, 0x3B, 0x34, 0x7B79},
    {0x01, 0x01, 0x01, 0x01, 0x00, 0x7B53},
    {0x5A, 0x5A, 0x5A, 0x5A, 0x73, 0x9369},
    {0x55, 0x55, 0x55, 0x55, 0x64, 0x936B},
    {0x28, 0x28, 0x28, 0x28, 0x5F, 0x936D},
    {0x03, 0x03, 0x03, 0x03, 0x03, 0x9304},
    {0x00, 0x00, 0x00, 0x00, 0x80, 0x9305},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9E9A},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9E9B},
    {0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x9E9C},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9E9D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9E9E},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x9E9F},
    {0x60, 0x60, 0x60, 0x60, 0x27, 0xA2A9},
    {0x00, 0x00, 0x00, 0x00, 0x03, 0xA2B7},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0401},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0404},
    {0x10, 0x10, 0x10, 0x10, 0x10, 0x0405},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0408},
    {0x00, 0x00, 0x00, 0x00, 0x04, 0x0409},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x040A},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x040B},
    {0x0F, 0x0F, 0x0F, 0x0B, 0x07, 0x040C},
    {0xD8, 0x00, 0x00, 0xB8, 0x80, 0x040D},
    {0x0B, 0x08, 0x08, 0x0B, 0x04, 0x040E},
    {0xE0, 0x70, 0x70, 0xB8, 0x38, 0x040F},
    {0x0F, 0x0F, 0x0F, 0x0B, 0x07, 0x034C},
    {0xD8, 0x00, 0x00, 0xB8, 0x80, 0x034D},
    {0x0B, 0x08, 0x08, 0x0B, 0x04, 0x034E},
    {0xE0, 0x70, 0x70, 0xB8, 0x38, 0x034F},
    {0x05, 0x05, 0x05, 0x05, 0x05, 0x0301},
    {0x02, 0x02, 0x02, 0x02, 0x02, 0x0303},
    {0x02, 0x02, 0x02, 0x02, 0x02, 0x0305},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0306},
    {0xAF, 0xAF, 0xAF, 0xAF, 0xAF, 0x0307},
    {0x0C, 0x0C, 0x0C, 0x0A, 0x0A, 0x0309},
    {0x01, 0x02, 0x01, 0x01, 0x01, 0x030B},
    {0x02, 0x02, 0x02, 0x02, 0x02, 0x030D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x030E},
    {0x7D, 0x88, 0x88, 0x73, 0x7D, 0x030F},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x0310},
    {0x17, 0x0C, 0x19, 0x15, 0x17, 0x0820},
    {0x70, 0xC0, 0x80, 0x90, 0x70, 0x0821},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0822},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0823},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x080A},
    {0x97, 0x67, 0x9F, 0x8F, 0x97, 0x080B},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x080C},
    {0x5F, 0x37, 0x67, 0x57, 0x5F, 0x080D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x080E},
    {0x9F, 0x57, 0xAF, 0x8F, 0x9F, 0x080F},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0810},
    {0x6F, 0x47, 0x77, 0x67, 0x6F, 0x0811},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0812},
    {0x6F, 0x47, 0x77, 0x67, 0x6F, 0x0813},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0814},
    {0x57, 0x37, 0x5F, 0x57, 0x57, 0x0815},
    {0x01, 0x00, 0x01, 0x01, 0x01, 0x0816},
    {0x87, 0xCF, 0xAF, 0x5F, 0x87, 0x0817},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0818},
    {0x4F, 0x2F, 0x57, 0x47, 0x4F, 0x0819},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xE04C},
    {0x9F, 0x57, 0xAF, 0x8F, 0x9F, 0xE04D},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xE04E},
    {0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0xE04F},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x3E20},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3E37},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x3F50},
    {0x00, 0x01, 0x00, 0x00, 0x00, 0x3F56},
    {0xE5, 0x60, 0xB5, 0x8F, 0x59, 0x3F57},

    {0x0D, 0x08, 0x08, 0x0D, 0x04, 0x3F3A}, //same frram line length (Addr 0x340 0x341)
    {0xAC, 0xe3, 0xA7, 0x20, 0x6A, 0x3F3B},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0830}, /* auto-deskew off */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x0832},
    {0x01, 0x01, 0x01, 0x01, 0x01, 0x0100},
} ;


int imx477_i2c_init(VI_PIPE ViPipe)
{
    int ret;
    char acDevFile[16];
    HI_U8 u8DevNum;

    if (g_fd[ViPipe] >= 0)
    {
        return 0;
    }

    u8DevNum = g_aunImx477BusInfo[ViPipe].s8I2cDev;

    snprintf(acDevFile, sizeof(acDevFile),  "/dev/i2c-%u", u8DevNum);

    g_fd[ViPipe] = open(acDevFile, O_RDWR);

    if (g_fd[ViPipe] < 0)
    {
        printf("Open /dev/hi_i2c_drv-%u error!\n", u8DevNum);
        return -1;
    }

    ret = ioctl(g_fd[ViPipe], I2C_SLAVE_FORCE, (imx477_i2c_addr >> 1));
    if (ret < 0)
    {
        printf("I2C_SLAVE_FORCE error!\n");
        close(g_fd[ViPipe]);
        g_fd[ViPipe] = -1;
        return ret;
    }

    return 0;
}

int imx477_i2c_exit(VI_PIPE ViPipe)
{
    if (g_fd[ViPipe] >= 0)
    {
        close(g_fd[ViPipe]);
        g_fd[ViPipe] = -1;
        return 0;
    }
    return -1;
}

int imx477_read_register(VI_PIPE ViPipe, int addr)
{
    // TODO:

    return 0;
}


int imx477_write_register(VI_PIPE ViPipe, int addr, int data)
{
    int ret;
    int idx = 0;
    char buf[8];

    if (0 > g_fd[ViPipe])
    {
        return 0;
    }

    if (imx477_addr_byte == 2)
    {
        buf[idx] = (addr >> 8) & 0xff;
        idx++;
        buf[idx] = addr & 0xff;
        idx++;
    }
    else
    {
        buf[idx] = addr & 0xff;
        idx++;
    }

    if (imx477_data_byte == 2)
    {
        buf[idx] = (data >> 8) & 0xff;
        idx++;
        buf[idx] = data & 0xff;
        idx++;
    }
    else
    {
        buf[idx] = data & 0xff;
        idx++;
    }

    ret = write(g_fd[ViPipe], buf, (imx477_addr_byte + imx477_data_byte));
    if (ret < 0)
    {
        printf("I2C_WRITE DATA error!\n");
        return -1;
    }

    return 0;
}

static void delay_ms(int ms)
{
    usleep(ms * 1000);
}

void imx477_standby(VI_PIPE ViPipe)
{
    // TODO:
    return;
}

void imx477_restart(VI_PIPE ViPipe)
{
    // TODO:
    return;
}

void imx477_init(VI_PIPE ViPipe)
{
    SLAVE_DEV  SlaveDev;
    HI_U8      u8ImgMode;

    SlaveDev  = g_Imx477SlaveBindDev[ViPipe];
    u8ImgMode = g_astImx477[ViPipe].u8ImgMode;

    HI_U8 u16RegData;
    HI_U16 u16RegAddr;
    HI_U32 i;
    HI_U32 u32SeqEntries;

    /* hold sync signal as fixed */
    CHECK_RET(HI_MPI_ISP_GetSnsSlaveAttr(SlaveDev, &gstImx477Sync[ViPipe]));

    gstImx477Sync[ViPipe].unCfg.stBits.bitHEnable = 0;
    gstImx477Sync[ViPipe].unCfg.stBits.bitVEnable = 0;
    CHECK_RET(HI_MPI_ISP_SetSnsSlaveAttr(SlaveDev, &gstImx477Sync[ViPipe]));

    /* 2. sensor i2c init */
    imx477_i2c_init(ViPipe);

    delay_ms(100);
    /* When sensor first init, config all registers */
    u32SeqEntries = sizeof(gs_au16SensorCfgSeq) / sizeof(gs_au16SensorCfgSeq[0]);

    for ( i = 0 ; i < u32SeqEntries; i++ )
    {
        u16RegAddr = gs_au16SensorCfgSeq[i][IMX477_MODE_BUTT];
        u16RegData = gs_au16SensorCfgSeq[i][u8ImgMode];

        imx477_write_register(ViPipe, u16RegAddr, u16RegData);
    }

#ifdef LENS_TYPE_DUAL_FISH
    if (IMX477_9M50FPS_LINER_MODE == g_u8SensorImageMode)
    {
        /*if use dual fish lens, device 0 need to do flip and mirror*/
        imx477_write_register(0, 0x101, 0x3);
    }
#endif

    CHECK_RET(HI_MPI_ISP_GetSnsSlaveAttr(SlaveDev, &gstImx477Sync[ViPipe]));

    if (g_astImx477[ViPipe].astRegsInfo[0].stSlvSync.u32SlaveVsTime == 0)
    {
        gstImx477Sync[ViPipe].u32VsTime = g_astImx477ModeTbl[u8ImgMode].u32InckPerVs;
    }
    else
    {
        gstImx477Sync[ViPipe].u32VsTime = g_astImx477[ViPipe].astRegsInfo[0].stSlvSync.u32SlaveVsTime;
    }

    gstImx477Sync[ViPipe].unCfg.u32Bytes = 0xc0030000;
    gstImx477Sync[ViPipe].u32VsCyc = 0x3;

	//for (i = 0; i < g_astImx477[ViPipe].astRegsInfo[0].u32RegNum; i++)
    //{
    //    imx477_write_register(ViPipe, g_astImx477[ViPipe].astRegsInfo[0].astI2cData[i].u32RegAddr, g_astImx477[ViPipe].astRegsInfo[0].astI2cData[i].u32Data);
    //}

    //slave open,master close
    CHECK_RET(HI_MPI_ISP_SetSnsSlaveAttr(SlaveDev, &gstImx477Sync[ViPipe]));

    printf("IMX477 %s init succuss!\n", g_astImx477ModeTbl[u8ImgMode].pszModeName);

    g_astImx477[ViPipe].bInit = HI_TRUE;
    g_bStart[ViPipe] = HI_TRUE;

    return ;
}

void imx477_exit(VI_PIPE ViPipe)
{
    imx477_i2c_exit(ViPipe);

    return;
}


