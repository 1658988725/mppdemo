/******************************************************************************

  Copyright (C), 2016, Hisilicon Tech. Co., Ltd.

 ******************************************************************************
  File Name     : isp_gamma.c
  Version       : Initial Draft
  Author        : Hisilicon multimedia software group
  Created       : 2013/01/16
  Description   :
  History       :
  1.Date        : 2013/01/16
    Author      :
    Modification: Created file

  2.Date        : 2016/09/03
    Author      :
    Modification: HDR related curve update

  3.Date       : 2017/02/07
    Author     :
    Modification: Add DeGamma curve LUT

******************************************************************************/
#include "isp_ext_config.h"
#include "isp_alg.h"
#include "isp_sensor.h"
#include "isp_config.h"
#include <math.h>

#ifdef __cplusplus
#if __cplusplus
extern "C" {
#endif
#endif /* End of #ifdef __cplusplus */

typedef struct hiISP_GAMMA_S
{
    HI_BOOL bEnable;
    HI_BOOL bLutUpdate;
} ISP_GAMMA_S;

ISP_GAMMA_S g_astGammaCtx[ISP_MAX_PIPE_NUM] = {{0}};
#define GAMMA_GET_CTX(dev, pstCtx)   pstCtx = &g_astGammaCtx[dev]

//Dafault Gamma curve
HI_U16 g_au16LinModeGamma[GAMMA_NODE_NUMBER] =
{

    0   ,    30  ,    60  ,    90  ,    120 ,    145 ,    170 ,    195 ,    220 ,    243 ,    265 ,    288 ,    310 ,    330 ,    350 ,    370 ,    390 ,    410 ,    430 ,    450 ,    470 ,    488 ,
    505 ,    523 ,    540 ,    558 ,    575 ,    593 ,    610 ,    625 ,    640 ,    655 ,    670 ,    685 ,    700 ,    715 ,    730 ,    744 ,    758 ,    772 ,    786 ,    800 ,    814 ,    828 ,
    842 ,    855 ,    868 ,    881 ,    894 ,    907 ,    919 ,    932 ,    944 ,    957 ,    969 ,    982 ,    994 ,    1008,    1022,    1036,    1050,    1062,    1073,    1085,    1096,    1107,
    1117,    1128,    1138,    1148,    1158,    1168,    1178,    1188,    1198,    1208,    1218,    1227,    1236,    1245,    1254,    1261,    1267,    1274,    1280,    1289,    1297,    1306,
    1314,    1322,    1330,    1338,    1346,    1354,    1362,    1370,    1378,    1386,    1393,    1401,    1408,    1416,    1423,    1431,    1438,    1445,    1453,    1460,    1467,    1474,
    1480,    1487,    1493,    1500,    1506,    1513,    1519,    1525,    1531,    1537,    1543,    1549,    1556,    1562,    1568,    1574,    1580,    1586,    1592,    1598,    1604,    1609,
    1615,    1621,    1627,    1632,    1638,    1644,    1650,    1655,    1661,    1667,    1672,    1678,    1683,    1689,    1694,    1700,    1705,    1710,    1716,    1721,    1726,    1732,
    1737,    1743,    1748,    1753,    1759,    1764,    1769,    1774,    1779,    1784,    1789,    1794,    1800,    1805,    1810,    1815,    1820,    1825,    1830,    1835,    1840,    1844,
    1849,    1854,    1859,    1864,    1869,    1874,    1879,    1883,    1888,    1893,    1898,    1902,    1907,    1912,    1917,    1921,    1926,    1931,    1936,    1940,    1945,    1950,
    1954,    1959,    1963,    1968,    1972,    1977,    1981,    1986,    1990,    1995,    1999,    2004,    2008,    2013,    2017,    2021,    2026,    2030,    2034,    2039,    2043,    2048,
    2052,    2056,    2061,    2065,    2069,    2073,    2078,    2082,    2086,    2090,    2094,    2098,    2102,    2106,    2111,    2115,    2119,    2123,    2128,    2132,    2136,    2140,
    2144,    2148,    2152,    2156,    2160,    2164,    2168,    2172,    2176,    2180,    2184,    2188,    2192,    2196,    2200,    2204,    2208,    2212,    2216,    2220,    2224,    2227,
    2231,    2235,    2239,    2243,    2247,    2251,    2255,    2258,    2262,    2266,    2270,    2273,    2277,    2281,    2285,    2288,    2292,    2296,    2300,    2303,    2307,    2311,
    2315,    2318,    2322,    2326,    2330,    2333,    2337,    2341,    2344,    2348,    2351,    2355,    2359,    2362,    2366,    2370,    2373,    2377,    2380,    2384,    2387,    2391,
    2394,    2398,    2401,    2405,    2408,    2412,    2415,    2419,    2422,    2426,    2429,    2433,    2436,    2440,    2443,    2447,    2450,    2454,    2457,    2461,    2464,    2467,
    2471,    2474,    2477,    2481,    2484,    2488,    2491,    2494,    2498,    2501,    2504,    2508,    2511,    2515,    2518,    2521,    2525,    2528,    2531,    2534,    2538,    2541,
    2544,    2547,    2551,    2554,    2557,    2560,    2564,    2567,    2570,    2573,    2577,    2580,    2583,    2586,    2590,    2593,    2596,    2599,    2603,    2606,    2609,    2612,
    2615,    2618,    2621,    2624,    2628,    2631,    2634,    2637,    2640,    2643,    2646,    2649,    2653,    2656,    2659,    2662,    2665,    2668,    2671,    2674,    2677,    2680,
    2683,    2686,    2690,    2693,    2696,    2699,    2702,    2705,    2708,    2711,    2714,    2717,    2720,    2723,    2726,    2729,    2732,    2735,    2738,    2741,    2744,    2747,
    2750,    2753,    2756,    2759,    2762,    2764,    2767,    2770,    2773,    2776,    2779,    2782,    2785,    2788,    2791,    2794,    2797,    2799,    2802,    2805,    2808,    2811,
    2814,    2817,    2820,    2822,    2825,    2828,    2831,    2834,    2837,    2840,    2843,    2845,    2848,    2851,    2854,    2856,    2859,    2862,    2865,    2868,    2871,    2874,
    2877,    2879,    2882,    2885,    2888,    2890,    2893,    2896,    2899,    2901,    2904,    2907,    2910,    2912,    2915,    2918,    2921,    2923,    2926,    2929,    2932,    2934,
    2937,    2940,    2943,    2945,    2948,    2951,    2954,    2956,    2959,    2962,    2964,    2967,    2969,    2972,    2975,    2977,    2980,    2983,    2986,    2988,    2991,    2994,
    2996,    2999,    3001,    3004,    3007,    3009,    3012,    3015,    3018,    3020,    3023,    3026,    3028,    3031,    3033,    3036,    3038,    3041,    3043,    3046,    3049,    3051,
    3054,    3057,    3059,    3062,    3064,    3067,    3069,    3072,    3074,    3077,    3080,    3082,    3085,    3088,    3090,    3093,    3095,    3098,    3100,    3103,    3105,    3108,
    3110,    3113,    3115,    3118,    3120,    3123,    3125,    3128,    3130,    3133,    3135,    3138,    3140,    3143,    3145,    3148,    3150,    3153,    3155,    3158,    3160,    3163,
    3165,    3168,    3170,    3173,    3175,    3178,    3180,    3183,    3185,    3187,    3190,    3192,    3194,    3197,    3199,    3202,    3204,    3207,    3209,    3212,    3214,    3217,
    3219,    3222,    3224,    3226,    3229,    3231,    3233,    3236,    3238,    3241,    3243,    3245,    3248,    3250,    3252,    3255,    3257,    3260,    3262,    3264,    3267,    3269,
    3271,    3274,    3276,    3279,    3281,    3283,    3286,    3288,    3290,    3293,    3295,    3298,    3300,    3302,    3305,    3307,    3309,    3311,    3314,    3316,    3318,    3320,
    3323,    3325,    3327,    3330,    3332,    3335,    3337,    3339,    3342,    3344,    3346,    3348,    3351,    3353,    3355,    3357,    3360,    3362,    3364,    3366,    3369,    3371,
    3373,    3375,    3378,    3380,    3382,    3384,    3387,    3389,    3391,    3393,    3396,    3398,    3400,    3402,    3405,    3407,    3409,    3411,    3414,    3416,    3418,    3420,
    3423,    3425,    3427,    3429,    3432,    3434,    3436,    3438,    3441,    3443,    3445,    3447,    3450,    3452,    3454,    3456,    3459,    3461,    3463,    3465,    3467,    3469,
    3471,    3473,    3476,    3478,    3480,    3482,    3485,    3487,    3489,    3491,    3494,    3496,    3498,    3500,    3502,    3504,    3506,    3508,    3511,    3513,    3515,    3517,
    3519,    3521,    3523,    3525,    3528,    3530,    3532,    3534,    3536,    3538,    3540,    3542,    3545,    3547,    3549,    3551,    3553,    3555,    3557,    3559,    3562,    3564,
    3566,    3568,    3570,    3572,    3574,    3576,    3579,    3581,    3583,    3585,    3587,    3589,    3591,    3593,    3596,    3598,    3600,    3602,    3604,    3606,    3608,    3610,
    3612,    3614,    3616,    3618,    3620,    3622,    3624,    3626,    3629,    3631,    3633,    3635,    3637,    3639,    3641,    3643,    3645,    3647,    3649,    3651,    3653,    3655,
    3657,    3659,    3661,    3663,    3665,    3667,    3670,    3672,    3674,    3676,    3678,    3680,    3682,    3684,    3686,    3688,    3690,    3692,    3694,    3696,    3698,    3700,
    3702,    3704,    3706,    3708,    3710,    3712,    3714,    3716,    3718,    3720,    3722,    3724,    3726,    3728,    3730,    3732,    3734,    3736,    3738,    3740,    3742,    3744,
    3746,    3748,    3750,    3752,    3754,    3756,    3758,    3760,    3762,    3764,    3766,    3767,    3769,    3771,    3773,    3775,    3777,    3779,    3781,    3783,    3785,    3787,
    3789,    3791,    3793,    3795,    3797,    3799,    3801,    3803,    3805,    3806,    3808,    3810,    3812,    3814,    3816,    3818,    3820,    3822,    3824,    3826,    3828,    3830,
    3832,    3834,    3836,    3837,    3839,    3841,    3843,    3845,    3847,    3849,    3851,    3853,    3855,    3857,    3859,    3860,    3862,    3864,    3866,    3868,    3870,    3872,
    3874,    3875,    3877,    3879,    3881,    3883,    3885,    3887,    3889,    3890,    3892,    3894,    3896,    3898,    3900,    3902,    3904,    3905,    3907,    3909,    3911,    3913,
    3915,    3917,    3919,    3920,    3922,    3924,    3926,    3928,    3930,    3932,    3934,    3935,    3937,    3939,    3941,    3943,    3945,    3947,    3949,    3950,    3952,    3954,
    3956,    3957,    3959,    3961,    3963,    3965,    3967,    3969,    3971,    3972,    3974,    3976,    3978,    3979,    3981,    3983,    3985,    3987,    3989,    3991,    3993,    3994,
    3996,    3998,    4000,    4001,    4003,    4005,    4007,    4008,    4010,    4012,    4014,    4016,    4018,    4020,    4022,    4023,    4025,    4027,    4029,    4030,    4032,    4034,
    4036,    4037,    4039,    4041,    4043,    4044,    4046,    4048,    4050,    4052,    4054,    4056,    4058,    4059,    4061,    4063,    4065,    4066,    4068,    4070,    4072,    4073,
    4075,    4077,    4079,    4080,    4082,    4084,    4086,    4087,    4089,    4091,    4092,    4094,    4095,

};

HI_U16 g_au16WDRModeGamma[GAMMA_NODE_NUMBER] =
{

    0   ,    30  ,    60  ,    90  ,    120 ,    145 ,    170 ,    195 ,    220 ,    243 ,    265 ,    288 ,    310 ,    330 ,    350 ,    370 ,    390 ,    410 ,    430 ,    450 ,    470 ,    488 ,
    505 ,    523 ,    540 ,    558 ,    575 ,    593 ,    610 ,    625 ,    640 ,    655 ,    670 ,    685 ,    700 ,    715 ,    730 ,    744 ,    758 ,    772 ,    786 ,    800 ,    814 ,    828 ,
    842 ,    855 ,    868 ,    881 ,    894 ,    907 ,    919 ,    932 ,    944 ,    957 ,    969 ,    982 ,    994 ,    1008,    1022,    1036,    1050,    1062,    1073,    1085,    1096,    1107,
    1117,    1128,    1138,    1148,    1158,    1168,    1178,    1188,    1198,    1208,    1218,    1227,    1236,    1245,    1254,    1261,    1267,    1274,    1280,    1289,    1297,    1306,
    1314,    1322,    1330,    1338,    1346,    1354,    1362,    1370,    1378,    1386,    1393,    1401,    1408,    1416,    1423,    1431,    1438,    1445,    1453,    1460,    1467,    1474,
    1480,    1487,    1493,    1500,    1506,    1513,    1519,    1525,    1531,    1537,    1543,    1549,    1556,    1562,    1568,    1574,    1580,    1586,    1592,    1598,    1604,    1609,
    1615,    1621,    1627,    1632,    1638,    1644,    1650,    1655,    1661,    1667,    1672,    1678,    1683,    1689,    1694,    1700,    1705,    1710,    1716,    1721,    1726,    1732,
    1737,    1743,    1748,    1753,    1759,    1764,    1769,    1774,    1779,    1784,    1789,    1794,    1800,    1805,    1810,    1815,    1820,    1825,    1830,    1835,    1840,    1844,
    1849,    1854,    1859,    1864,    1869,    1874,    1879,    1883,    1888,    1893,    1898,    1902,    1907,    1912,    1917,    1921,    1926,    1931,    1936,    1940,    1945,    1950,
    1954,    1959,    1963,    1968,    1972,    1977,    1981,    1986,    1990,    1995,    1999,    2004,    2008,    2013,    2017,    2021,    2026,    2030,    2034,    2039,    2043,    2048,
    2052,    2056,    2061,    2065,    2069,    2073,    2078,    2082,    2086,    2090,    2094,    2098,    2102,    2106,    2111,    2115,    2119,    2123,    2128,    2132,    2136,    2140,
    2144,    2148,    2152,    2156,    2160,    2164,    2168,    2172,    2176,    2180,    2184,    2188,    2192,    2196,    2200,    2204,    2208,    2212,    2216,    2220,    2224,    2227,
    2231,    2235,    2239,    2243,    2247,    2251,    2255,    2258,    2262,    2266,    2270,    2273,    2277,    2281,    2285,    2288,    2292,    2296,    2300,    2303,    2307,    2311,
    2315,    2318,    2322,    2326,    2330,    2333,    2337,    2341,    2344,    2348,    2351,    2355,    2359,    2362,    2366,    2370,    2373,    2377,    2380,    2384,    2387,    2391,
    2394,    2398,    2401,    2405,    2408,    2412,    2415,    2419,    2422,    2426,    2429,    2433,    2436,    2440,    2443,    2447,    2450,    2454,    2457,    2461,    2464,    2467,
    2471,    2474,    2477,    2481,    2484,    2488,    2491,    2494,    2498,    2501,    2504,    2508,    2511,    2515,    2518,    2521,    2525,    2528,    2531,    2534,    2538,    2541,
    2544,    2547,    2551,    2554,    2557,    2560,    2564,    2567,    2570,    2573,    2577,    2580,    2583,    2586,    2590,    2593,    2596,    2599,    2603,    2606,    2609,    2612,
    2615,    2618,    2621,    2624,    2628,    2631,    2634,    2637,    2640,    2643,    2646,    2649,    2653,    2656,    2659,    2662,    2665,    2668,    2671,    2674,    2677,    2680,
    2683,    2686,    2690,    2693,    2696,    2699,    2702,    2705,    2708,    2711,    2714,    2717,    2720,    2723,    2726,    2729,    2732,    2735,    2738,    2741,    2744,    2747,
    2750,    2753,    2756,    2759,    2762,    2764,    2767,    2770,    2773,    2776,    2779,    2782,    2785,    2788,    2791,    2794,    2797,    2799,    2802,    2805,    2808,    2811,
    2814,    2817,    2820,    2822,    2825,    2828,    2831,    2834,    2837,    2840,    2843,    2845,    2848,    2851,    2854,    2856,    2859,    2862,    2865,    2868,    2871,    2874,
    2877,    2879,    2882,    2885,    2888,    2890,    2893,    2896,    2899,    2901,    2904,    2907,    2910,    2912,    2915,    2918,    2921,    2923,    2926,    2929,    2932,    2934,
    2937,    2940,    2943,    2945,    2948,    2951,    2954,    2956,    2959,    2962,    2964,    2967,    2969,    2972,    2975,    2977,    2980,    2983,    2986,    2988,    2991,    2994,
    2996,    2999,    3001,    3004,    3007,    3009,    3012,    3015,    3018,    3020,    3023,    3026,    3028,    3031,    3033,    3036,    3038,    3041,    3043,    3046,    3049,    3051,
    3054,    3057,    3059,    3062,    3064,    3067,    3069,    3072,    3074,    3077,    3080,    3082,    3085,    3088,    3090,    3093,    3095,    3098,    3100,    3103,    3105,    3108,
    3110,    3113,    3115,    3118,    3120,    3123,    3125,    3128,    3130,    3133,    3135,    3138,    3140,    3143,    3145,    3148,    3150,    3153,    3155,    3158,    3160,    3163,
    3165,    3168,    3170,    3173,    3175,    3178,    3180,    3183,    3185,    3187,    3190,    3192,    3194,    3197,    3199,    3202,    3204,    3207,    3209,    3212,    3214,    3217,
    3219,    3222,    3224,    3226,    3229,    3231,    3233,    3236,    3238,    3241,    3243,    3245,    3248,    3250,    3252,    3255,    3257,    3260,    3262,    3264,    3267,    3269,
    3271,    3274,    3276,    3279,    3281,    3283,    3286,    3288,    3290,    3293,    3295,    3298,    3300,    3302,    3305,    3307,    3309,    3311,    3314,    3316,    3318,    3320,
    3323,    3325,    3327,    3330,    3332,    3335,    3337,    3339,    3342,    3344,    3346,    3348,    3351,    3353,    3355,    3357,    3360,    3362,    3364,    3366,    3369,    3371,
    3373,    3375,    3378,    3380,    3382,    3384,    3387,    3389,    3391,    3393,    3396,    3398,    3400,    3402,    3405,    3407,    3409,    3411,    3414,    3416,    3418,    3420,
    3423,    3425,    3427,    3429,    3432,    3434,    3436,    3438,    3441,    3443,    3445,    3447,    3450,    3452,    3454,    3456,    3459,    3461,    3463,    3465,    3467,    3469,
    3471,    3473,    3476,    3478,    3480,    3482,    3485,    3487,    3489,    3491,    3494,    3496,    3498,    3500,    3502,    3504,    3506,    3508,    3511,    3513,    3515,    3517,
    3519,    3521,    3523,    3525,    3528,    3530,    3532,    3534,    3536,    3538,    3540,    3542,    3545,    3547,    3549,    3551,    3553,    3555,    3557,    3559,    3562,    3564,
    3566,    3568,    3570,    3572,    3574,    3576,    3579,    3581,    3583,    3585,    3587,    3589,    3591,    3593,    3596,    3598,    3600,    3602,    3604,    3606,    3608,    3610,
    3612,    3614,    3616,    3618,    3620,    3622,    3624,    3626,    3629,    3631,    3633,    3635,    3637,    3639,    3641,    3643,    3645,    3647,    3649,    3651,    3653,    3655,
    3657,    3659,    3661,    3663,    3665,    3667,    3670,    3672,    3674,    3676,    3678,    3680,    3682,    3684,    3686,    3688,    3690,    3692,    3694,    3696,    3698,    3700,
    3702,    3704,    3706,    3708,    3710,    3712,    3714,    3716,    3718,    3720,    3722,    3724,    3726,    3728,    3730,    3732,    3734,    3736,    3738,    3740,    3742,    3744,
    3746,    3748,    3750,    3752,    3754,    3756,    3758,    3760,    3762,    3764,    3766,    3767,    3769,    3771,    3773,    3775,    3777,    3779,    3781,    3783,    3785,    3787,
    3789,    3791,    3793,    3795,    3797,    3799,    3801,    3803,    3805,    3806,    3808,    3810,    3812,    3814,    3816,    3818,    3820,    3822,    3824,    3826,    3828,    3830,
    3832,    3834,    3836,    3837,    3839,    3841,    3843,    3845,    3847,    3849,    3851,    3853,    3855,    3857,    3859,    3860,    3862,    3864,    3866,    3868,    3870,    3872,
    3874,    3875,    3877,    3879,    3881,    3883,    3885,    3887,    3889,    3890,    3892,    3894,    3896,    3898,    3900,    3902,    3904,    3905,    3907,    3909,    3911,    3913,
    3915,    3917,    3919,    3920,    3922,    3924,    3926,    3928,    3930,    3932,    3934,    3935,    3937,    3939,    3941,    3943,    3945,    3947,    3949,    3950,    3952,    3954,
    3956,    3957,    3959,    3961,    3963,    3965,    3967,    3969,    3971,    3972,    3974,    3976,    3978,    3979,    3981,    3983,    3985,    3987,    3989,    3991,    3993,    3994,
    3996,    3998,    4000,    4001,    4003,    4005,    4007,    4008,    4010,    4012,    4014,    4016,    4018,    4020,    4022,    4023,    4025,    4027,    4029,    4030,    4032,    4034,
    4036,    4037,    4039,    4041,    4043,    4044,    4046,    4048,    4050,    4052,    4054,    4056,    4058,    4059,    4061,    4063,    4065,    4066,    4068,    4070,    4072,    4073,
    4075,    4077,    4079,    4080,    4082,    4084,    4086,    4087,    4089,    4091,    4092,    4094,    4095,

};

HI_U16 g_au16HDRModeGamma[GAMMA_NODE_NUMBER] =
{

    0,  6, 13, 19, 25, 31, 38, 44, 50, 56, 62, 69, 75, 81, 87, 93, 100, 106, 112, 118, 124, 130, 137, 143, 149, 155, 161, 168, 174, 180, 186, 192,
    199, 205, 211, 217, 223, 230, 236, 242, 248, 255, 261, 267, 273, 280, 286, 292, 299, 305, 311, 318, 324, 331, 337, 343, 350, 356, 363, 369, 376, 382, 389, 395,
    402, 408, 415, 422, 428, 435, 442, 448, 455, 462, 469, 475, 482, 489, 496, 503, 510, 517, 523, 530, 537, 544, 551, 558, 565, 572, 579, 586, 593, 600, 607, 614,
    621, 628, 635, 642, 649, 656, 663, 670, 677, 684, 691, 698, 705, 712, 718, 725, 732, 739, 746, 753, 760, 767, 774, 781, 788, 794, 801, 808, 815, 822, 828, 835,
    842, 849, 855, 862, 869, 876, 882, 889, 896, 903, 909, 916, 923, 929, 936, 943, 950, 956, 963, 970, 976, 983, 990, 996, 1003, 1010, 1017, 1023, 1030, 1036, 1043, 1050,
    1056, 1063, 1070, 1076, 1083, 1089, 1096, 1103, 1109, 1116, 1122, 1129, 1135, 1142, 1148, 1155, 1161, 1168, 1174, 1181, 1187, 1193, 1200, 1206, 1213, 1219, 1225, 1232, 1238, 1244, 1250, 1257,
    1263, 1269, 1275, 1282, 1288, 1294, 1300, 1307, 1313, 1319, 1326, 1332, 1338, 1344, 1351, 1357, 1363, 1369, 1376, 1382, 1388, 1394, 1400, 1407, 1413, 1419, 1425, 1431, 1437, 1443, 1449, 1455,
    1462, 1468, 1474, 1480, 1486, 1491, 1497, 1503, 1509, 1515, 1521, 1527, 1532, 1538, 1544, 1549, 1555, 1561, 1566, 1572, 1577, 1583, 1588, 1593, 1599, 1604, 1609, 1615, 1620, 1625, 1630, 1635,
    1640, 1645, 1650, 1655, 1659, 1664, 1669, 1674, 1678, 1683, 1687, 1692, 1696, 1701, 1705, 1709, 1714, 1718, 1722, 1726, 1730, 1735, 1739, 1743, 1747, 1751, 1755, 1759, 1763, 1767, 1771, 1775,
    1778, 1782, 1786, 1790, 1794, 1798, 1801, 1805, 1809, 1813, 1816, 1820, 1824, 1828, 1831, 1835, 1839, 1843, 1846, 1850, 1854, 1858, 1862, 1865, 1869, 1873, 1877, 1881, 1884, 1888, 1892, 1896,
    1900, 1904, 1908, 1912, 1916, 1919, 1923, 1927, 1931, 1935, 1939, 1943, 1947, 1951, 1954, 1958, 1962, 1966, 1970, 1974, 1978, 1981, 1985, 1989, 1993, 1997, 2000, 2004, 2008, 2012, 2016, 2020,
    2023, 2027, 2031, 2035, 2038, 2042, 2046, 2050, 2054, 2057, 2061, 2065, 2069, 2072, 2076, 2080, 2084, 2087, 2091, 2095, 2099, 2102, 2106, 2110, 2113, 2117, 2121, 2124, 2128, 2132, 2136, 2139,
    2143, 2147, 2150, 2154, 2158, 2161, 2165, 2169, 2172, 2176, 2180, 2183, 2187, 2191, 2194, 2198, 2201, 2205, 2209, 2212, 2216, 2220, 2223, 2227, 2230, 2234, 2238, 2241, 2245, 2248, 2252, 2256,
    2259, 2263, 2266, 2270, 2274, 2277, 2281, 2284, 2288, 2291, 2295, 2298, 2302, 2306, 2309, 2313, 2316, 2320, 2323, 2327, 2330, 2334, 2337, 2341, 2344, 2348, 2351, 2355, 2359, 2362, 2366, 2369,
    2373, 2376, 2379, 2383, 2386, 2390, 2393, 2397, 2400, 2404, 2407, 2411, 2414, 2418, 2421, 2425, 2428, 2432, 2435, 2438, 2442, 2445, 2449, 2452, 2456, 2459, 2463, 2466, 2469, 2473, 2476, 2480,
    2483, 2486, 2490, 2493, 2497, 2500, 2504, 2507, 2510, 2514, 2517, 2520, 2524, 2527, 2531, 2534, 2537, 2541, 2544, 2548, 2551, 2554, 2558, 2561, 2564, 2568, 2571, 2574, 2578, 2581, 2584, 2588,
    2591, 2594, 2598, 2601, 2604, 2608, 2611, 2614, 2618, 2621, 2624, 2628, 2631, 2634, 2638, 2641, 2644, 2648, 2651, 2654, 2658, 2661, 2664, 2667, 2671, 2674, 2677, 2681, 2684, 2687, 2690, 2694,
    2697, 2700, 2703, 2707, 2710, 2713, 2717, 2720, 2723, 2726, 2730, 2733, 2736, 2739, 2743, 2746, 2749, 2752, 2756, 2759, 2762, 2765, 2768, 2772, 2775, 2778, 2781, 2785, 2788, 2791, 2794, 2797,
    2801, 2804, 2807, 2810, 2813, 2817, 2820, 2823, 2826, 2829, 2833, 2836, 2839, 2842, 2845, 2849, 2852, 2855, 2858, 2861, 2864, 2868, 2871, 2874, 2877, 2880, 2883, 2887, 2890, 2893, 2896, 2899,
    2902, 2906, 2909, 2912, 2915, 2918, 2921, 2924, 2928, 2931, 2934, 2937, 2940, 2943, 2946, 2949, 2953, 2956, 2959, 2962, 2965, 2968, 2971, 2974, 2978, 2981, 2984, 2987, 2990, 2993, 2996, 2999,
    3002, 3005, 3009, 3012, 3015, 3018, 3021, 3024, 3027, 3030, 3033, 3036, 3039, 3042, 3046, 3049, 3052, 3055, 3058, 3061, 3064, 3067, 3070, 3073, 3076, 3079, 3082, 3085, 3088, 3091, 3095, 3098,
    3101, 3104, 3107, 3110, 3113, 3116, 3119, 3122, 3125, 3128, 3131, 3134, 3137, 3140, 3143, 3146, 3149, 3152, 3155, 3158, 3161, 3164, 3167, 3170, 3173, 3176, 3179, 3182, 3185, 3188, 3191, 3194,
    3197, 3200, 3203, 3206, 3209, 3212, 3215, 3218, 3221, 3224, 3227, 3230, 3233, 3236, 3239, 3242, 3245, 3248, 3251, 3254, 3257, 3260, 3263, 3266, 3269, 3272, 3275, 3278, 3281, 3284, 3287, 3290,
    3293, 3295, 3298, 3301, 3304, 3307, 3310, 3313, 3316, 3319, 3322, 3325, 3328, 3331, 3334, 3337, 3340, 3343, 3345, 3348, 3351, 3354, 3357, 3360, 3363, 3366, 3369, 3372, 3375, 3378, 3381, 3383,
    3386, 3389, 3392, 3395, 3398, 3401, 3404, 3407, 3410, 3412, 3415, 3418, 3421, 3424, 3427, 3430, 3433, 3436, 3439, 3441, 3444, 3447, 3450, 3453, 3456, 3459, 3462, 3464, 3467, 3470, 3473, 3476,
    3479, 3482, 3485, 3487, 3490, 3493, 3496, 3499, 3502, 3505, 3507, 3510, 3513, 3516, 3519, 3522, 3525, 3527, 3530, 3533, 3536, 3539, 3542, 3545, 3547, 3550, 3553, 3556, 3559, 3562, 3564, 3567,
    3570, 3573, 3576, 3579, 3581, 3584, 3587, 3590, 3593, 3596, 3598, 3601, 3604, 3607, 3610, 3612, 3615, 3618, 3621, 3624, 3626, 3629, 3632, 3635, 3638, 3641, 3643, 3646, 3649, 3652, 3655, 3657,
    3660, 3663, 3666, 3669, 3671, 3674, 3677, 3680, 3682, 3685, 3688, 3691, 3694, 3696, 3699, 3702, 3705, 3708, 3710, 3713, 3716, 3719, 3721, 3724, 3727, 3730, 3732, 3735, 3738, 3741, 3744, 3746,
    3749, 3752, 3755, 3757, 3760, 3763, 3766, 3768, 3771, 3774, 3777, 3779, 3782, 3785, 3788, 3790, 3793, 3796, 3799, 3801, 3804, 3807, 3810, 3812, 3815, 3818, 3821, 3823, 3826, 3829, 3831, 3834,
    3837, 3840, 3842, 3845, 3848, 3851, 3853, 3856, 3859, 3861, 3864, 3867, 3870, 3872, 3875, 3878, 3880, 3883, 3886, 3889, 3891, 3894, 3897, 3899, 3902, 3905, 3908, 3910, 3913, 3916, 3918, 3921,
    3924, 3926, 3929, 3932, 3935, 3937, 3940, 3943, 3945, 3948, 3951, 3953, 3956, 3959, 3961, 3964, 3967, 3969, 3972, 3975, 3978, 3980, 3983, 3986, 3988, 3991, 3994, 3996, 3999, 4002, 4004, 4007,
    4010, 4012, 4015, 4018, 4020, 4023, 4026, 4028, 4031, 4034, 4036, 4039, 4042, 4044, 4047, 4050, 4052, 4055, 4057, 4060, 4063, 4065, 4068, 4071, 4073, 4076, 4079, 4081, 4084, 4087, 4089, 4092, 4095
};

static HI_VOID GammaUsrRegsInit(ISP_GAMMA_USR_CFG_S *pstUsrRegCfg, HI_U16 *pau16Gamma)
{
    pstUsrRegCfg->bResh             = HI_TRUE;
    pstUsrRegCfg->bGammaLutUpdateEn = HI_TRUE;
    pstUsrRegCfg->u32UpdateIndex    = 1;
    memcpy(pstUsrRegCfg->au16GammaLUT, pau16Gamma, GAMMA_NODE_NUMBER * sizeof(HI_U16));
}

static HI_VOID GammaRegsInitialize(VI_PIPE ViPipe, ISP_REG_CFG_S *pstRegCfg)
{
    HI_U16 i;
    HI_U8  u8WDRMode;
    HI_U16 *pau16GAMMA = HI_NULL;
    // HI_U32 u32NodeNum;
    // HI_FLOAT f16GammaInput, f16GammaOutput;
    // HI_FLOAT f16MaxValue = 4095.0f;
    // HI_U16   au16GAMMA[GAMMA_NODE_NUMBER];

    ISP_GAMMA_S *pstGammaCtx = HI_NULL;

    ISP_CTX_S  *pstIspCtx = HI_NULL;
    ISP_CMOS_DEFAULT_S *pstSnsDft = HI_NULL;

    ISP_SensorGetDefault(ViPipe, &pstSnsDft);
    ISP_GET_CTX(ViPipe, pstIspCtx);
    GAMMA_GET_CTX(ViPipe, pstGammaCtx);

    pstGammaCtx->bEnable    = HI_TRUE;
    pstGammaCtx->bLutUpdate = HI_TRUE;

    u8WDRMode  = pstIspCtx->u8SnsWDRMode;

    if ( DYNAMIC_RANGE_XDR == pstIspCtx->stHdrAttr.enDynamicRange )
    {
        pau16GAMMA   = g_au16HDRModeGamma;

        //hi_ext_system_gamma_curve_type_write(ViPipe, ISP_GAMMA_CURVE_HDR);
        hi_ext_system_gamma_curve_type_write(ViPipe, ISP_GAMMA_CURVE_USER_DEFINE);
        printf("GAMMA initialize in HDR mode success!\n");
    }
    else
    {
        /*Read from CMOS*/
        if (pstSnsDft->stGamma.bValid)
        {
            pau16GAMMA = pstSnsDft->stGamma.au16Gamma;
            hi_ext_system_gamma_curve_type_write(ViPipe, ISP_GAMMA_CURVE_USER_DEFINE);
        }
        else
            /*Load from firmware*/
        {
            /*Read from firmware*/
            if ( IS_LINEAR_MODE(u8WDRMode))
            {
                /*Initialize*/
                pau16GAMMA = g_au16LinModeGamma;
            }
            else
            {
                pau16GAMMA = g_au16WDRModeGamma;
            }
        }
    }

    for (i = 0 ; i < GAMMA_NODE_NUMBER ; i++)
    {
        hi_ext_system_gamma_lut_write(ViPipe, i, pau16GAMMA[i]);
    }

    for (i = 0 ; i < pstRegCfg->u8CfgNum; i++)
    {
        GammaUsrRegsInit(&pstRegCfg->stAlgRegCfg[i].stGammaCfg.stUsrRegCfg, pau16GAMMA);
        pstRegCfg->stAlgRegCfg[i].stGammaCfg.bGammaEn = HI_TRUE;
    }

    pstRegCfg->unKey.bit1GammaCfg = 1;

    return;
}

static HI_VOID GammaExtRegsInitialize(VI_PIPE ViPipe)
{
    //Only extern reg is gamma curve type
    hi_ext_system_gamma_en_write(ViPipe, HI_TRUE);
    hi_ext_system_gamma_lut_update_write(ViPipe, HI_FALSE);
    hi_ext_system_gamma_curve_type_write(ViPipe, HI_EXT_SYSTEM_GAMMA_CURVE_TYPE_DEFAULT);
    return;
}

static HI_S32 GammaReadExtRegs(VI_PIPE ViPipe)
{
    ISP_GAMMA_S *pstGammaCtx = HI_NULL;

    GAMMA_GET_CTX(ViPipe, pstGammaCtx);

    pstGammaCtx->bLutUpdate = hi_ext_system_gamma_lut_update_read(ViPipe);
    hi_ext_system_gamma_lut_update_write(ViPipe, HI_FALSE);

    return 0;
}

HI_S32 ISP_GammaInit(VI_PIPE ViPipe, HI_VOID *pRegCfg)
{
    ISP_REG_CFG_S *pstRegCfg = (ISP_REG_CFG_S *)pRegCfg;

    GammaExtRegsInitialize(ViPipe);
    GammaRegsInitialize(ViPipe, pstRegCfg);

    return HI_SUCCESS;
}

static HI_VOID ISP_GammaWdrModeSet(VI_PIPE ViPipe, HI_VOID *pRegCfg)
{
    HI_U8  i;
    HI_U32 au32UpdateIdx[ISP_STRIPING_MAX_NUM] = {0};
    ISP_REG_CFG_S *pstRegCfg = (ISP_REG_CFG_S *)pRegCfg;

    for (i = 0; i < pstRegCfg->u8CfgNum; i++)
    {
        au32UpdateIdx[i] = pstRegCfg->stAlgRegCfg[i].stGammaCfg.stUsrRegCfg.u32UpdateIndex;
    }

    ISP_GammaInit(ViPipe, pRegCfg);

    for (i = 0; i < pstRegCfg->u8CfgNum; i++)
    {
        pstRegCfg->stAlgRegCfg[i].stGammaCfg.stUsrRegCfg.u32UpdateIndex = au32UpdateIdx[i] + 1;
    }
}

static HI_BOOL __inline CheckGammaOpen(ISP_GAMMA_S *pstGamma)
{
    return (HI_TRUE == pstGamma->bEnable);
}

HI_S32 ISP_GammaRun(VI_PIPE ViPipe, const HI_VOID *pStatInfo,
                    HI_VOID *pRegCfg, HI_S32 s32Rsv)
{

    HI_U16 i, j;
    ISP_REG_CFG_S *pstReg = (ISP_REG_CFG_S *)pRegCfg;

    ISP_GAMMA_S *pstGammaCtx = HI_NULL;
    ISP_GAMMA_USR_CFG_S   *pstUsrRegCfg = HI_NULL;
    GAMMA_GET_CTX(ViPipe, pstGammaCtx);

    pstGammaCtx->bEnable = hi_ext_system_gamma_en_read(ViPipe);

    for (i = 0; i < pstReg->u8CfgNum; i++)
    {

        pstReg->stAlgRegCfg[i].stGammaCfg.bGammaEn = pstGammaCtx->bEnable;
    }

    pstReg->unKey.bit1GammaCfg = 1;

    /*check hardware setting*/
    if (!CheckGammaOpen(pstGammaCtx))
    {
        return HI_SUCCESS;
    }

    GammaReadExtRegs(ViPipe);

    if (pstGammaCtx->bLutUpdate)
    {
        for (i = 0; i < pstReg->u8CfgNum; i++)
        {
            pstUsrRegCfg = &pstReg->stAlgRegCfg[i].stGammaCfg.stUsrRegCfg;
            for (j = 0 ; j < GAMMA_NODE_NUMBER ; j++)
            {
                pstUsrRegCfg->au16GammaLUT[j] = hi_ext_system_gamma_lut_read(ViPipe, j);
            }
            pstUsrRegCfg->bGammaLutUpdateEn = HI_TRUE;
            pstUsrRegCfg->u32UpdateIndex   += 1;
        }
    }

    return HI_SUCCESS;
}

HI_S32 ISP_GammaCtrl(VI_PIPE ViPipe, HI_U32 u32Cmd, HI_VOID *pValue)
{
    ISP_REGCFG_S  *pRegCfg = HI_NULL;

    REGCFG_GET_CTX(ViPipe, pRegCfg);

    switch (u32Cmd)
    {
        case ISP_WDR_MODE_SET :
            ISP_GammaWdrModeSet(ViPipe, (HI_VOID *)&pRegCfg->stRegCfg);
            break;
        default :
            break;
    }

    return HI_SUCCESS;
}

HI_S32 ISP_GammaExit(VI_PIPE ViPipe)
{
#if 0
    HI_U8 i;
    ISP_CTX_S *pstIspCtx = HI_NULL;

    ISP_GET_CTX(ViPipe, pstIspCtx);

    for (i = 0; i < pstIspCtx->stBlockAttr.u8BlockNum; i++)
    {
        hi_ext_system_gamma_en_write(ViPipe, HI_FALSE);
    }
#endif
    return HI_SUCCESS;
}

HI_S32 ISP_AlgRegisterGamma(VI_PIPE ViPipe)
{
    ISP_CTX_S *pstIspCtx = HI_NULL;
    ISP_ALG_NODE_S *pstAlgs = HI_NULL;

    ISP_GET_CTX(ViPipe, pstIspCtx);

    pstAlgs = ISP_SearchAlg(pstIspCtx->astAlgs);
    ISP_CHECK_POINTER(pstAlgs);

    pstAlgs->enAlgType = ISP_ALG_GAMMA;
    pstAlgs->stAlgFunc.pfn_alg_init = ISP_GammaInit;
    pstAlgs->stAlgFunc.pfn_alg_run  = ISP_GammaRun;
    pstAlgs->stAlgFunc.pfn_alg_ctrl = ISP_GammaCtrl;
    pstAlgs->stAlgFunc.pfn_alg_exit = ISP_GammaExit;
    pstAlgs->bUsed = HI_TRUE;

    return HI_SUCCESS;
}

#ifdef __cplusplus
#if __cplusplus
}
#endif
#endif /* End of #ifdef __cplusplus */

